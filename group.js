const puppeteer=require("puppeteer"),fs=require("fs").promises,path=require("path"),config=require("./configgroup.json"),fetch=require("node-fetch"),VALIDATION_SERVER_URL="https://license-server-botnews.vercel.app/api/validate",PRODUCT_NAME="autokomenfb";async function checkLicense(){console.log("Memulai validasi lisensi...");const e=process.env.BOT_LICENSE_EMAIL;if(!e)throw new Error("KESALAHAN: GitHub Secret 'BOT_LICENSE_EMAIL' tidak ditemukan atau belum diatur.");const a=`${VALIDATION_SERVER_URL}?email=${encodeURIComponent(e)}&product=${PRODUCT_NAME}`;try{const e=await fetch(a),t=await e.json();if(e.ok&&"valid"===t.status)return console.log("✅ Lisensi valid."),!0;throw new Error(`Lisensi tidak valid - Pesan dari server: ${t.message||"Tidak ada pesan"}`)}catch(e){throw new Error(`Gagal menghubungi server lisensi: ${e.message}`)}}const COMMENTS_PATH=path.join(__dirname,"comments.txt"),ARTIFACTS_DIR=path.join(__dirname,"artifacts"),delay=e=>new Promise(a=>setTimeout(a,e)),getRandomInterval=()=>1e3*(Math.floor(Math.random()*(config.maxIntervalSeconds-config.minIntervalSeconds+1))+config.minIntervalSeconds);async function loadCookiesFromEnv(){const e=process.env.FACEBOOK_COOKIES;if(!e)throw new Error("Secret FACEBOOK_COOKIES belum diatur di GitHub!");return JSON.parse(e).map(e=>({name:e.name,value:e.value,domain:e.domain,path:e.path}))}async function loadComments(){try{return(await fs.readFile(COMMENTS_PATH,"utf8")).split("---").map(e=>e.trim()).filter(e=>e)}catch(e){if("ENOENT"===e.code)return[];throw e}}async function main(){try{await checkLicense(),console.log("🚀 Memulai bot auto-komen untuk Feed Grup..."),await fs.mkdir(ARTIFACTS_DIR,{recursive:!0});const e=await puppeteer.launch({headless:config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]}),a=await e.newPage();await a.setViewport({width:1280,height:1024});try{console.log("🔑 Memuat dan membersihkan cookies...");const e=await loadCookiesFromEnv();await a.setCookie(...e),console.log(`✅ ${e.length} cookies berhasil dimuat.`),console.log(`Navigasi ke: ${config.targetURL}`),await a.goto(config.targetURL,{waitUntil:"networkidle2"}),console.log("Menunggu halaman memuat konten awal..."),await delay(1e4),console.log("✅ Halaman dianggap sudah siap."),await a.screenshot({path:path.join(ARTIFACTS_DIR,"1_setelah_login_grup.png")});const t=await loadComments();if(0===t.length)throw new Error("File comments.txt kosong atau tidak ditemukan!");const o=new Set;let n=0,i=0;console.log(`🎯 Target: ${config.postsToComment} komentar.`);let s=0;for(;i<config.postsToComment&&s<5;){await a.screenshot({path:path.join(ARTIFACTS_DIR,"2_sebelum_aksi_grup.png")});const e=await a.$$("div[aria-posinset]");if(console.log(`Menemukan ${e.length} kartu postingan potensial.`),0===e.length){console.log("Tidak ada kartu postingan ditemukan. Scroll ke bawah..."),await a.evaluate(()=>window.scrollBy(0,800)),await delay(5e3),s++;continue}let r=!1;for(const l of e)try{const e=await l.evaluate(e=>e.getAttribute("aria-posinset"));if(!e||o.has(e))continue;const c=await l.$("p.xdj266r.x14z9mp.xat24cr.x1lziwak");if(!c){o.add(e);continue}const d=await c.evaluateHandle(e=>e.closest('div[role="button"], div[role="textbox"]'));if(!d.asElement()){o.add(e);continue}console.log(`\n🔎 Menemukan postingan baru (posisi: ${e})...`),await d.asElement().click({delay:100}),console.log("   -> ✅ Area komentar diaktifkan."),await delay(2e3);const g=t[n%t.length];console.log(`   -> 💬 Mengetik komentar:\n${g}`);const m=g.split("\n");for(const e of m)await a.keyboard.type(e,{delay:100}),await a.keyboard.down("Shift"),await a.keyboard.press("Enter"),await a.keyboard.up("Shift");await a.keyboard.press("Enter"),console.log("   -> ✅ Komentar dikirim dengan menekan Enter."),o.add(e),i++,n++,r=!0,s=0;const u=getRandomInterval();console.log(`   -> 🕒 Jeda selama ${u/1e3} detik...`),await delay(u),await a.keyboard.press("Escape").catch(()=>{}),await delay(2e3);break}catch(e){console.error(`   -> ❌ Gagal berinteraksi dengan satu postingan: ${e.message}`),await a.keyboard.press("Escape").catch(()=>{}),await delay(2e3)}if(i>=config.postsToComment){console.log("Target jumlah komentar tercapai.");break}r||(console.log("Semua postingan yang terlihat sudah dicoba. Scroll ke bawah..."),await a.evaluate(()=>window.scrollBy(0,window.innerHeight)),await delay(5e3),s++)}s>=5&&console.log("❌ Tidak ada postingan baru ditemukan setelah 5 kali scroll. Bot berhenti.")}finally{e&&await e.close(),console.log("🏁 Bot selesai.")}}catch(e){console.error("Terjadi error fatal:",e.message),process.exit(1)}}main();
