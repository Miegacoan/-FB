const puppeteer=require("puppeteer"),fs=require("fs").promises,path=require("path"),config=require("./config.json"),fetch=require("node-fetch"),VALIDATION_SERVER_URL="https://license-server-botnews.vercel.app/api/validate",PRODUCT_NAME="autokomenfb";async function checkLicense(){console.log("Memulai validasi lisensi...");const e=process.env.BOT_LICENSE_EMAIL;if(!e)throw new Error("KESALAHAN: GitHub Secret 'BOT_LICENSE_EMAIL' tidak ditemukan atau belum diatur.");const a=`${VALIDATION_SERVER_URL}?email=${encodeURIComponent(e)}&product=${PRODUCT_NAME}`;try{const e=await fetch(a),o=await e.json();if(e.ok&&"valid"===o.status)return console.log("‚úÖ Lisensi valid."),!0;throw new Error(`Lisensi tidak valid - Pesan dari server: ${o.message||"Tidak ada pesan"}`)}catch(e){throw new Error(`Gagal menghubungi server lisensi: ${e.message}`)}}const LOG_PATH=path.join(__dirname,"ceklink.txt"),COMMENTS_PATH=path.join(__dirname,"comments.txt"),ARTIFACTS_DIR=path.join(__dirname,"artifacts"),delay=e=>new Promise(a=>setTimeout(a,e)),getRandomInterval=()=>1e3*(Math.floor(Math.random()*(config.maxIntervalSeconds-config.minIntervalSeconds+1))+config.minIntervalSeconds);async function loadCookiesFromEnv(){const e=process.env.FACEBOOK_COOKIES;if(!e)throw new Error("Secret FACEBOOK_COOKIES belum diatur di GitHub!");return JSON.parse(e).map(e=>({name:e.name,value:e.value,domain:e.domain,path:e.path}))}async function loadLog(){try{const e=await fs.readFile(LOG_PATH,"utf8");return new Set(e.split("\n").filter(e=>""!==e.trim()))}catch(e){if("ENOENT"===e.code)return new Set;throw e}}async function loadComments(){try{return(await fs.readFile(COMMENTS_PATH,"utf8")).split("---").map(e=>e.trim()).filter(e=>e)}catch(e){if("ENOENT"===e.code)return[];throw e}}async function appendToLog(e){await fs.appendFile(LOG_PATH,`${e}\n`)}async function main(){let e;try{await checkLicense(),console.log("üöÄ Memulai bot auto-komen untuk Video..."),await fs.mkdir(ARTIFACTS_DIR,{recursive:!0}),e=await puppeteer.launch({headless:config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]});const a=await e.newPage();await a.setViewport({width:1280,height:1024}),console.log("üîë Memuat dan membersihkan cookies...");const o=await loadCookiesFromEnv();await a.setCookie(...o),console.log(`‚úÖ ${o.length} cookies berhasil dimuat.`),console.log(`Navigasi ke: ${config.targetURL}`),await a.goto(config.targetURL,{waitUntil:"networkidle2"}),console.log("Menunggu halaman memuat konten awal..."),await delay(1e4),console.log("‚úÖ Halaman dianggap sudah siap."),await a.screenshot({path:path.join(ARTIFACTS_DIR,"1_setelah_login.png")});const t=await loadLog(),n=await loadComments();if(0===n.length)throw new Error("File comments.txt kosong atau tidak ditemukan!");let i=t.size%n.length,r=0;console.log(`üéØ Target: ${config.postsToComment} komentar.`);let s=0;const l=5;for(;r<config.postsToComment&&s<l;){await a.screenshot({path:path.join(ARTIFACTS_DIR,"2_sebelum_aksi.png")});const e=await a.evaluate(()=>Array.from(document.querySelectorAll('a[href*="/watch/?v="]')).map(e=>e.href.split("&")[0]));if(console.log(`Menemukan ${e.length} URL video potensial.`),0===e.length){console.log("Tidak ada link video ditemukan. Scroll ke bawah..."),await a.evaluate(()=>window.scrollBy(0,800)),await delay(5e3),s++;continue}let o=!1;for(const l of e)try{if(t.has(l))continue;console.log(`\nNavigasi ke halaman video: ${l}`),await a.goto(l,{waitUntil:"networkidle2"}),await delay(5e3),console.log(`   -> ‚úÖ Postingan baru ditemukan: ${l}`);const e=await a.waitForSelector('div[aria-label="Beri komentar"]',{timeout:1e4});await e.click({delay:100}),console.log('   -> ‚úÖ Tombol "Beri komentar" diklik.'),console.log("   -> üïí Menunggu 5 detik..."),await delay(5e3);const c=n[i];console.log(`   -> üí¨ Mengetik komentar:\n${c}`);const d=c.split("\n");for(const e of d)await a.keyboard.type(e,{delay:100}),await a.keyboard.down("Shift"),await a.keyboard.press("Enter"),await a.keyboard.up("Shift");await a.keyboard.press("Enter"),console.log("   -> ‚úÖ Komentar dikirim dengan menekan Enter."),await appendToLog(l),t.add(l),r++,i=(i+1)%n.length,o=!0,s=0;const g=getRandomInterval();console.log(`   -> üïí Jeda selama ${g/1e3} detik...`),await delay(g),console.log(`Kembali ke ${config.targetURL}...`),await a.goto(config.targetURL,{waitUntil:"networkidle2"}),await delay(5e3);break}catch(e){console.error(`   -> ‚ùå Gagal berinteraksi dengan postingan di ${l}: ${e.message}`),console.log("   -> Kembali ke halaman utama untuk mencoba lagi..."),await a.goto(config.targetURL,{waitUntil:"networkidle2"}),await delay(5e3);break}if(r>=config.postsToComment){console.log("Target jumlah komentar tercapai.");break}o||(console.log("Semua postingan yang terlihat sudah dikomentari. Scroll ke bawah..."),await a.evaluate(()=>window.scrollBy(0,window.innerHeight)),await delay(5e3),s++)}s>=l&&console.log(`‚ùå Tidak ada link video baru ditemukan setelah ${l} kali scroll. Bot berhenti.`)}catch(a){console.error("Terjadi error fatal:",a.message);const o=path.join(ARTIFACTS_DIR,"error_fatal.png");try{if(e){const a=(await e.pages())[0]||await e.newPage();await a.screenshot({path:o,fullPage:!0}),console.log(`Screenshot error disimpan di: ${o}`)}}catch(e){console.error("Gagal menyimpan screenshot error.",e)}process.exit(1)}finally{e&&await e.close(),console.log("üèÅ Bot selesai.")}}main();
